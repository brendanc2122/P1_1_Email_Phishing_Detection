<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phishing Email Detector</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Downloaded jQuery to handle button click event -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>

<body>
  <div class="container">
    <!-- Left: input -->
    <div class="detector-panel">
      <center>
        <h1>Phishing Email Detector</h1>
        <p>Upload a text or email file for phishing analysis</p>
      </center>

      <form id="uploadForm">
        <center>
          <input type="file" id="filesInput" class="custom-btn" enctype="multipart/form-data" multiple accept=".txt,.eml">
          <button type="submit" class="upload-btn">Upload</button>
        </center>

        <script>
          // Preprocess file upload
          const test_form = document.getElementById("uploadForm")
          document.getElementById("uploadForm").addEventListener("submit", function (event) {
            event.preventDefault();
            var userData = new FormData();
            var files = document.getElementById("filesInput").files;
            for (var x = 0; x <= files.length; x++)
              userData.append('file', files[x])
            $.ajax({
              type: 'POST',
              url: '/upload',
              data: userData,
              processData: false,
              contentType: false,
              // If succeessful, adds response to element with id test_result
              success: function (response) {
                alert("Success")
                add_results(response)
                // var response_parts = response.split('|');
                // document.getElementById("test-score").innerHTML = response_parts[0];
                // document.getElementById("test-reasons").innerHTML = response_parts[1];
              },
              // Else, show error message
              error: function (error) {
                console.log(error);
              }
            })
          })
        </script>
      </form>
    
<div class="result-panel">
  <h1>Result</h1>
<div class="result-header">
  <div id="results-carousel" class="carousel carousel-dark slide">
    <div id="carousel-itemslist" class="carousel-inner">
      <!-- Carousel items will be dynamically added here -->
    </div>
    <div id="carousel-buttons">
      <!-- Buttons will be dynamically added here -->
    </div>
  </div>
</div>
</div>

<script>
  function add_results(response) {
    console.log(response);
    for (let i = 0; i < response.length; i++) {
      if (i == 0) {
        // At least 1 carousel item needs "active" class
        var active_carouselHTML = `
          <div class="carousel-item active">
            <div class="email-details">
              <h4>Email ${i+1} details</h4>
              <p><strong>Sender:</strong> ${response[i].domain}</p>
              <p><strong>Subject:</strong> ${response[i].subject}</p>
            </div>
            <div class="risk-level">
              <h4>Analysis</h4>
              <p><strong>Score:</strong> ${response[i].score} (${response[i].risk_level})</p>
            </div>
            <div class="breakdown">
              <h4>Breakdown (indicators)</h4>
               <ul>
                ${response[i].reasons.map(reason => `<li>${reason}</li>`).join("")}
              </ul>
            </div>
          </div>
        `;
        document.querySelector('#results-carousel .carousel-inner').innerHTML = active_carouselHTML;
        } else {
          var carouselHTML = `
          <div class="carousel-item">
            <div class="email-details">
              <h4>Email ${i+1} details</h4>
              <p><strong>Sender:</strong> ${response[i].domain}</p>
              <p><strong>Subject:</strong> ${response[i].subject}</p>
            </div>
            <div class="risk-level">
              <h4>Analysis</h4>
              <p><strong>Score:</strong> ${response[i].score} (${response[i].risk_level})</p>
            </div>
            <div class="breakdown">
              <h4>Breakdown (indicators)</h4>
              <ul>
                ${response[i].reasons.map(reason => `<li>${reason}</li>`).join("")}
              </ul>
            </div>
          </div>
        `;
        document.querySelector('#results-carousel .carousel-inner').innerHTML += carouselHTML;
        }
      // Add carousel buttons
      if (response.length > 1) {
        var buttonHTML = `
          <button id="carousel-buttons-left" class="carousel-control-prev" type="button" data-bs-target="#results-carousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button id="carousel-buttons-right" class="carousel-control-next" type="button" data-bs-target="#results-carousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        `;
        document.getElementById('carousel-buttons').innerHTML += buttonHTML;
      }
    }
  }

  // Email analyze form (existing, but ensure it uses fetch and updates UI)
  document.querySelector('.email-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const sender = document.getElementById('sender').value;
    const subject = document.getElementById('subject').value;
    const body = document.getElementById('body').value;
    const threshold = document.getElementById('threshold').value;

        const response = await fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sender, subject, body, threshold })
        });
        const result = await response.json();

        // Update result UI (implement as needed)
        document.querySelector('.result-score .score-label').textContent =
          result.score !== undefined ? `Score: ${result.score}` : 'No analysis yet';
        document.getElementById('result-threshold').textContent = threshold;
        // ...update breakdown, contributions, etc...
      });

  // Threshold slider update
  document.getElementById('threshold').addEventListener('input', function() {
    document.getElementById('threshold-value').textContent = this.value;
    document.getElementById('result-threshold').textContent = this.value;
  });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>

</html>